<!DOCTYPE html>
<html>
<head>
  <title>fluid</title>
  <style>
  </style>
</head>
<body class="enable-scroll">
    <canvas id="canvas" width=500 height=500/>
    <script>

      var canvas = document.getElementById('canvas');
      var ctx = canvas.getContext('2d');

      const constrain = (low, high, x) => Math.max(low, Math.min(high, x))
      const range = (end) => [...Array(end).keys()]
      const field = (res, value) => range(res).map(i => range(res).map(j => value(i,j)))
      const wave = (x) => Math.sin(6.28*x)*0.5 + 0.5

      var res = 100
      var cell = 5
      var terrain = field(res, (i,j) => wave(i/res)*0.25 + wave(j/res)*0.25 + 0.25*Math.random())
      var fluid = field(res, () => 0.2)
      var sludge = field(res, () => 0)

      function draw(grid, color, modify) {
        for(var i=0; i<res; i++) {
          for(var j=0; j<res; j++) {
            var value = constrain(0, 1, grid[i][j] + (modify || 0))
            ctx.fillStyle = 'rgba('+color+', '+value+')'
            ctx.fillRect(i*cell, j*cell, cell, cell)
          }
        }
      }

      function smoothed(grid) {
        var buffer = field(res, () => 0)
        for(var i=0; i<res; i++) {
          for(var j=0; j<res; j++) {
            var x = constrain(1, res-2, i)
            var y = constrain(1, res-2, j)
            buffer[i][j] = (4*grid[x][y] + grid[x+1][y] + grid[x][y+1] + grid[x-1][y] + grid[x][y-1])/8
          }
        }
        return buffer
      }

      function fluidDelta(terrain, fluid, dt, i, j) {
        var x = constrain(1, res-2, i)
        var y = constrain(1, res-2, j)
        var h = terrain[i][j] + fluid[i][j]
        var h00 = terrain[x-1][y-1] + fluid[x-1][y-1]
        var h10 = terrain[x+1][y-1] + fluid[x+1][y-1]
        var h01 = terrain[x-1][y+1] + fluid[x-1][y+1]
        var h11 = terrain[x+1][y+1] + fluid[x+1][y+1]
        return 0.25*(h00+h01+h10+h11 - 4*h)
      }

      function simulateFluid(erosion, sedimentation, dt) {
        var fluid2 = field(res, () => 0)
        var terrain2 = field(res, () => 0)
        for(var i=0; i<res; i++) {
          for(var j=0; j<res; j++) {
            var delta = fluidDelta(terrain, fluid, dt, i, j)
            fluid2[i][j] = Math.max(0, fluid[i][j] + dt * delta)
            var deltaSludge = erosion*Math.abs(delta) - sedimentation*sludge[i][j]
            terrain2[i][j] = terrain[i][j] - dt * deltaSludge
            sludge[i][j] = sludge[i][j] + dt * deltaSludge
          }
        }
        fluid = fluid2
        terrain = terrain2
      }

      function update() {
        for(var e in range(20)) {
          simulateFluid(0.4, 0.7, 0.8)
        }
        ctx.fillStyle = '#000'
        ctx.fillRect(0, 0, res*cell, res*cell)
        draw(terrain, '255,255,255')
        //draw(fluid, '0,0,255', -0.1)
        draw(sludge, '255,0,0')
      }
      
      for(var e in range(5)) {
        terrain = smoothed(terrain)
      }

      setInterval(update, 50)
      update()

    </script>
</body>
</html>